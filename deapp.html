<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Advanced Sensor Research Platform</title>

<style>
body {
    margin: 0;
    background: #0b0f14;
    color: #e6e6e6;
    font-family: system-ui;
}

header {
    padding: 14px;
    border-bottom: 1px solid #222;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

button {
    background: #238636;
    color: white;
    border: none;
    padding: 8px 14px;
    border-radius: 6px;
    cursor: pointer;
}

.grid {
    display: grid;
    grid-template-columns: repeat(auto-fit,minmax(260px,1fr));
    gap: 12px;
    padding: 12px;
}

.card {
    background: #151b23;
    border-radius: 12px;
    padding: 12px;
    position: relative;
}

.card h3 {
    margin: 0 0 6px 0;
    font-size: 14px;
    color: #58a6ff;
}

.value {
    font-size: 22px;
    font-weight: 600;
}

canvas {
    width: 100%;
    height: 160px;
    border-radius: 8px;
    background: #090c10;
}

.expand {
    position: absolute;
    top: 8px;
    right: 8px;
    cursor: pointer;
    opacity: 0.6;
}
</style>
</head>

<body>

<header>
    <div>Advanced Research Sensor System</div>
    <div>
        <button onclick="connectUSB()">USB Sensor</button>
        <button onclick="startCamera()">Camera</button>
    </div>
</header>

<div class="grid">

<div class="card">
<h3>Altitude</h3>
<div class="value" id="alt">0</div>
</div>

<div class="card">
<h3>Temperature</h3>
<div class="value" id="temp">N/A</div>
</div>

<div class="card">
<h3>Humidity</h3>
<div class="value" id="hum">N/A</div>
</div>

<div class="card">
<h3>Acceleration</h3>
<div class="value" id="acc">0</div>
<canvas id="accGraph"></canvas>
</div>

<div class="card">
<h3>Distance (m)</h3>
<div class="value" id="dist">0</div>
</div>

<div class="card">
<h3>Motion Type (AI)</h3>
<div class="value" id="motion">Idle</div>
</div>

<div class="card">
<h3>Camera</h3>
<video id="cam" autoplay muted playsinline style="width:100%;border-radius:8px;"></video>
</div>

<div class="card">
<h3>Heatmap (GPS)</h3>
<canvas id="map"></canvas>
</div>

</div>


    <script>
/* ===================== GLOBAL ===================== */
let lastLat = null, lastLon = null;
let totalDistance = 0;
let accelHistory = [];
let useExternal = false;

/* ===================== KALMAN FILTER ===================== */
class Kalman {
    constructor(R=0.01, Q=3) {
        this.R = R;
        this.Q = Q;
        this.A = 1;
        this.B = 0;
        this.C = 1;
        this.cov = NaN;
        this.x = NaN;
    }

    filter(z) {
        if (isNaN(this.x)) {
            this.x = z;
            this.cov = 1;
        } else {
            const predX = this.A * this.x;
            const predCov = this.A * this.cov * this.A + this.Q;
            const K = predCov * this.C / (this.C * predCov * this.C + this.R);
            this.x = predX + K * (z - this.C * predX);
            this.cov = predCov - K * this.C * predCov;
        }
        return this.x;
    }
}

const kalmanAcc = new Kalman();

/* ===================== GPS & DISTANCE ===================== */
function haversine(lat1, lon1, lat2, lon2) {
    const R = 6371000;
    const dLat = (lat2-lat1)*Math.PI/180;
    const dLon = (lon2-lon1)*Math.PI/180;
    const a =
      Math.sin(dLat/2)**2 +
      Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*
      Math.sin(dLon/2)**2;
    return 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

navigator.geolocation.watchPosition(pos=>{
    const {latitude, longitude, altitude} = pos.coords;

    if(lastLat !== null){
        totalDistance += haversine(lastLat, lastLon, latitude, longitude);
    }

    lastLat = latitude;
    lastLon = longitude;

    document.getElementById("alt").textContent = altitude?.toFixed(1) ?? "N/A";
    document.getElementById("dist").textContent = totalDistance.toFixed(1);
});

        /* ===================== MOTION ===================== */
window.addEventListener("devicemotion", e=>{
    if(!e.accelerationIncludingGravity) return;

    const a = e.accelerationIncludingGravity;
    const mag = Math.sqrt(a.x*a.x + a.y*a.y + a.z*a.z);
    const filtered = kalmanAcc.filter(mag);

    document.getElementById("acc").textContent = filtered.toFixed(2);
    accelHistory.push(filtered);
    if(accelHistory.length > 50) accelHistory.shift();

    // AI SIMPLE CLASSIFIER
    let state = "Idle";
    if(filtered > 12) state = "Running";
    else if(filtered > 3) state = "Walking";
    document.getElementById("motion").textContent = state;

    drawGraph();
});

/* ===================== GRAPH ===================== */
function drawGraph(){
    const c = document.getElementById("accGraph");
    const ctx = c.getContext("2d");
    c.width = c.clientWidth;
    c.height = c.clientHeight;
    ctx.clearRect(0,0,c.width,c.height);
    ctx.beginPath();
    ctx.strokeStyle = "#58a6ff";

    accelHistory.forEach((v,i)=>{
        const x = (i/50)*c.width;
        const y = c.height - v*6;
        i===0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y);
    });
    ctx.stroke();
}

/* ===================== CAMERA ===================== */
async function startCamera(){
    const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"user"}});
    document.getElementById("cam").srcObject = stream;
}
</script>

</body>
</html>
